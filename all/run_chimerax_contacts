import os
from chimerax.core.commands import run, CmdDesc, register, OpenFolderNameArg, BoolArg

def open_alphafold_models_from_folders(session, directory='.', open_pae=True):
    # Get a list of all subdirectories (folders) in the specified directory
    folders = [folder for folder in os.listdir(directory) if os.path.isdir(os.path.join(directory, folder))]

    if not folders:
        raise ValueError(f"No subfolders found in directory '{directory}'")

    models = []
    for folder in folders:
        folder_path = os.path.join(directory, folder)
        # Find AlphaFold structure files (e.g., .pdb.gz) in each subfolder
        filenames = [filename for filename in os.listdir(folder_path)
                     if filename.endswith('ranked_0.pdb')]

        if not filenames:
            print(f"No AlphaFold model files found in subfolder '{folder}'")
            continue

        # Open each model file found in the subfolder
        for filename in filenames:
            model_path = os.path.join(folder_path, filename)
            result = run(session, f'open {model_path}')

            if isinstance(result, list):
                # Handle the case where multiple models are returned
                for model in result:
                    if hasattr(model, 'id'):
                        model_name = os.path.splitext(filename)[0]
                        run(session, 'light full')
                        run(session, 'view')
                        models.append(model)
                    else:
                        print(f"Model '{filename}' could not be opened properly.")
            else:
                # Handle the case where a single model is returned
                if hasattr(result, 'id'):
                    model = result
                    model_name = os.path.splitext(filename)[0]
                    run(session, 'light full')
                    run(session, 'view')
                    models.append(model)
                else:
                    print(f"Model '{filename}' could not be opened properly.")

    # Open PAE file if requested
    if open_pae:
        open_pae_files_recursive(session, directory)

    return models

def open_pae_files_recursive(session, directory):
    # Recursively find PAE files in the specified directory and its subfolders
    for root, _, files in os.walk(directory):
        for filename in files:
            if filename.endswith('pae_model_1_multimer_v3_pred_0.json'):
                pae_path = os.path.join(root, filename)
                model_number = os.path.splitext(filename)[0].split('_')[-1]
                structure_id = find_structure_id(root, model_number)
                if structure_id:
                    run(session, f'tools structure prediction alphafold error plot file {pae_path} structure {structure_id}')
                else:
                    print(f"No corresponding structure found for PAE file '{filename}'.")

def find_structure_id(folder_path, model_number):
    # Function to find and return the structure ID associated with the specified model number
    for filename in os.listdir(folder_path):
        if filename.endswith('ranked_0.pdb'):
            model_path = os.path.join(folder_path, filename)
            result = run(session, f'open {model_path}')
            if isinstance(result, list):
                for model in result:
                    if hasattr(model, 'id') and isinstance(model.id, str) and model.id.endswith(f'_{model_number}'):
                        return model.id
            else:
                if hasattr(result, 'id') and isinstance(result.id, str) and result.id.endswith(f'_{model_number}'):
                    return result.id
    return None

def register_commands(session):
    desc_open = CmdDesc(keyword=[('directory', OpenFolderNameArg)],
                        optional=[('open_pae', BoolArg)],
                        synopsis='Open AlphaFold models from folders within a directory and optionally open PAE files')
    register('openalphafoldfolders', desc_open, open_alphafold_models_from_folders, logger=session.logger)

register_commands(session)
    # To run this script in ChimeraX, use the following command:
    # chimerax --nogui --script /path/to/this_script.py <base_directory> <pae> <distance>
    main(base_directory, pae, distance)
